using System;
using System.Collections.Generic;
using System.IO;
using System.IO.Compression;
using System.Linq;
using System.Text.RegularExpressions;
using System.Threading;
using System.Threading.Tasks;

class Program
{
    static void Main()
    {
        // Read the directory paths from the config file
        string configFilePath = "config.txt"; // Specify the path to your config file
        List<string> directoryPaths = ReadDirectoryPaths(configFilePath);

        // Create the Output_Files folder
        string outputFolderPath = Path.Combine(Directory.GetCurrentDirectory(), "Output_Files");
        Directory.CreateDirectory(outputFolderPath);

        // Process each directory path concurrently
        Parallel.ForEach(directoryPaths, directoryPath =>
        {
            ProcessDirectory(directoryPath, outputFolderPath);
        });

        // User input for datetime
        Console.WriteLine("Enter a datetime in the format 'yyyyMMdd_HHmmss':");
        string dateTimeString = Console.ReadLine();
        DateTime inputDateTime = ConvertToDateTime(dateTimeString);

        // Compare the input datetime with StartTime and EndTime
        CompareDateTime(inputDateTime, outputFolderPath);

        Console.WriteLine("Press any key to exit.");
        Console.ReadKey();
    }

    // Read the directory paths from the config file
    static List<string> ReadDirectoryPaths(string filePath)
    {
        List<string> directoryPaths = new List<string>();

        try
        {
            string[] lines = File.ReadAllLines(filePath);

            foreach (string line in lines)
            {
                // Skip empty lines or lines starting with a comment character (e.g., '#')
                if (string.IsNullOrWhiteSpace(line) || line.Trim().StartsWith("#"))
                    continue;

                // Add the directory path to the list
                directoryPaths.Add(line.Trim());
            }
        }
        catch (IOException ex)
        {
            Console.WriteLine($"Error reading config file: {ex.Message}");
        }

        return directoryPaths;
    }

    // Process a directory and its subdirectories
    static void ProcessDirectory(string directoryPath, string outputFolderPath)
    {
        try
        {
            // Get the directory name from the path
            string directoryName = Path.GetFileName(directoryPath);

            // Create a subfolder inside the Output_Files folder based on the directory name
            string subfolderPath = Path.Combine(outputFolderPath, directoryName);
            Directory.CreateDirectory(subfolderPath);

            // List all files in the directory and its subfolders
            List<string> fileNames = ListAllFiles(directoryPath);

            // Process each file
            foreach (string fileName in fileNames)
            {
                // Extract the DateTime from the file name
                string dateTimeString = ExtractDateTimeFromFileName(fileName);
                DateTime startTime = ConvertToDateTime(dateTimeString);

                // Get the EndTime using LastWriteTime of the file inside the compressed file
                DateTime endTime = DateTime.MinValue;
                if (IsZipFile(fileName))
                {
                    string zipFilePath = Path.Combine(directoryPath, fileName);
                    endTime = GetLastWriteTimeInZipFile(zipFilePath, fileName);
                }
                else
                {
                    endTime = File.GetLastWriteTime(fileName);
                }

                // Print the file name and corresponding StartTime and EndTime
                Console.WriteLine($"{fileName} - StartTime: {startTime} - EndTime: {endTime}");

                // ...
                // Rest of the file processing logic
                // ...
            }
        }
        catch (IOException ex)
        {
            Console.WriteLine($"Error processing directory '{directoryPath}': {ex.Message}");
        }
    }

    // Compare the input datetime with StartTime and EndTime
    static void CompareDateTime(DateTime inputDateTime, string outputFolderPath)
    {
        try
        {
            // Get all the files in the output folder and its subfolders
            List<string> fileNames = ListAllFiles(outputFolderPath);

            // Process each file
            foreach (string fileName in fileNames)
            {
                // Extract the DateTime from the file name
                string dateTimeString = ExtractDateTimeFromFileName(fileName);
                DateTime startTime = ConvertToDateTime(dateTimeString);

                // Get the EndTime using LastWriteTime of the file inside the compressed file
                DateTime endTime = DateTime.MinValue;
                if (IsZipFile(fileName))
                {
                    string zipFilePath = GetParentDirectoryPath(fileName);
                    string zipEntryFileName = GetFileNameFromPath(fileName);
                    endTime = GetLastWriteTimeInZipFile(zipFilePath, zipEntryFileName);
                }
                else
                {
                    endTime = File.GetLastWriteTime(fileName);
                }

                // Compare the input datetime with StartTime and EndTime
                bool isBetween = inputDateTime >= startTime && inputDateTime <= endTime;

                // Print the file name, StartTime, EndTime, and the comparison result
                Console.WriteLine($"{fileName} - StartTime: {startTime} - EndTime: {endTime} - IsBetween: {isBetween}");
            }
        }
        catch (IOException ex)
        {
            Console.WriteLine($"Error comparing datetime: {ex.Message}");
        }
    }

    // Rest of the methods...

    // ...
    // Rest of the code
    // ...
}
